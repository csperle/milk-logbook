# Project State

- Last updated date: 2026-02-23
- Current goal: implement vertical slice `011-expense-type-pl-categorization`.
- Active feature spec(s):
  - `011-expense-type-pl-categorization` (draft)
  - `010-improved-annual-pl-view` (implemented)
  - `009-annual-pl-view-in-app` (implemented, superseded by `010`)
  - `008-yearly-overview-default-home` (implemented, pending product sign-off)

## What is implemented
- Company context guard slice (`002-company-context-guard`) is implemented.
- Company admin UI is available at `/admin/companies`.
- Company API endpoints exist: `GET /api/companies`, `POST /api/companies`, `DELETE /api/companies/:id`.
- Company creation enforces trim/non-empty validation, max length 100, and case-insensitive uniqueness.
- Active company is persisted in cookie key `activeCompanyId`.
- Guard behavior is enforced for non-company-admin routes when no company exists or no valid active company is selected.
- Company admin page shows clear warning guidance when navigation is blocked by missing company setup/context.
- Main page header shows active company in a top-right bordered link to company admin.
- Expense type admin UI is available at `/admin/expense-types`.
- Root/home navigation links to `/admin/expense-types`.
- API endpoints exist: `GET /api/expense-types`, `POST /api/expense-types`, `DELETE /api/expense-types/:id`.
- SQLite persistence is implemented via `better-sqlite3` with local DB file `data/app.db`.
- Expense type creation enforces trim/non-empty validation and case-insensitive uniqueness.
- Expense type text length is validated with a max of 100 characters.
- Expense type order is persisted in the database and returned consistently by `GET /api/expense-types`.
- Expense type admin UI supports reordering (move up/down) and persists changes via API.
- Delete flow includes confirmation in UI and deterministic API statuses (`400/404/409/204`).
- Deletion is blocked when an expense type is referenced by `accounting_entries.type_of_expense_id`.
- API contract examples and local data reset workflow are documented in `README.md`.
- Invoice upload slice (`003-invoice-pdf-upload-local-storage`) is implemented.
- Upload UI is available at `/upload` and is protected by active-company context guard.
- Upload API endpoint exists: `POST /api/uploads`.
- Upload endpoint enforces:
  - `entryType` validation (`income` | `expense`)
  - max file size `10,485,760` bytes with `413`
  - PDF validation (`%PDF-` signature + MIME/extension rule)
  - deterministic error payload shape `{ error: { code, message } }`
- Local file persistence is implemented under project-root `upload/`.
- Upload metadata is persisted in SQLite table `invoice_uploads`:
  - `company_id`, `entry_type`, `original_filename`, `stored_filename`, `stored_path`, `uploaded_at`.
- Stored filenames are UUID-based and opaque; original filenames are persisted for future user-facing download naming.
- `stored_path` is persisted internally and not exposed in upload success responses.
- No-orphan guarantee is implemented: file write first, DB insert second, with file cleanup on DB failure.
- Company deletion now returns conflict (`409`) when the company is referenced by `invoice_uploads`.
- Manual review/save slice (`005-manual-review-save-from-upload`) is implemented.
- `POST /api/uploads` persists upload metadata only; accounting entries are still created only at explicit save time.
- Review APIs exist:
  - `GET /api/uploads/:id/review`
  - `PUT /api/uploads/:id/review`
  - `POST /api/uploads/:id/save`
- Review page UI is available at `/uploads/[id]/review` and is protected by active-company context guard.
- Draft persistence is implemented in `upload_review_drafts` (1:1 by `upload_id`), resumable across reload/navigation.
- Deterministic draft defaults are used when no draft exists (`Pending extraction`, zero gross, nullable conditional fields).
- Final accounting entry is created only on explicit save action.
- Booking entries persistence is implemented in `accounting_entries` with:
  - sequence key `(company_id, document_year, entry_type)`
  - document numbers starting at `1` per key
  - deterministic unique constraints for numbering and `upload_id`.
- `accounting_entries` links to uploads via `upload_id` (normalized metadata source).
- Final-save validation rules are enforced by `entryType`:
  - income requires `paymentReceivedDate` and forbids `typeOfExpenseId`
  - expense requires valid `typeOfExpenseId` and forbids `paymentReceivedDate`
- Double-save/concurrent save attempts are rejected deterministically with `409 ALREADY_SAVED`.
- Booking entries API endpoint exists: `GET /api/accounting-entries`.
- `GET /api/accounting-entries` is company-scoped via active cookie and sorted by `created_at DESC, id DESC`.
- Pending upload review queue slice (`006-pending-upload-review-queue`) is implemented.
- Upload queue UI is available at `/uploads` and is protected by active-company context guard.
- Upload queue API endpoint exists: `GET /api/uploads`.
- `GET /api/uploads` supports `status` filter (`pending_review` default, `saved`, `all`) with deterministic validation errors.
- Queue item review status is derived via join semantics (`pending_review` when no accounting entry exists, otherwise `saved`).
- Queue sorting is deterministic and company-scoped:
  - pending first
  - then `uploaded_at ASC`
  - tie-breaker `id ASC`
- Queue actions are status-specific:
  - pending items: `Review` -> `/uploads/{id}/review`
  - saved items: `Open overview` -> `/`
- Review page includes `Save entry and next` for pending uploads only.
- Save-and-next behavior:
  - saves current upload entry
  - opens next pending upload if one exists
  - handles `409 ALREADY_SAVED` race by continuing to the next pending item
  - redirects to `/uploads?status=pending_review&flash=saved_and_queue_empty` when none remain
- Queue supports deterministic flash messaging via URL query:
  - `flash=saved_and_opened_next`
  - `flash=saved_and_queue_empty`
- `/upload` now supports explicit capture-mode UX without forced review redirect after success:
  - primary action remains upload next file
  - secondary actions: review current upload now, open pending queue
- Processing-mode queue UX now includes a clear primary CTA (`Review oldest pending`) when pending items exist.
- Upload review PDF preview slice (`007-upload-review-pdf-preview`) is implemented.
- File preview API endpoint exists: `GET /api/uploads/:id/file`.
- File endpoint behavior includes:
  - active-company scoping
  - deterministic error shape/codes (`INVALID_ACTIVE_COMPANY`, `UPLOAD_NOT_FOUND`, `FILE_NOT_FOUND`, `FILE_READ_FAILED`)
  - `Content-Type: application/pdf`
  - `Content-Disposition` inline by default and attachment via `?download=1`
  - `Cache-Control: private, max-age=120`
  - `Vary: Cookie`
- Review page (`/uploads/[id]/review`) now includes:
  - inline PDF preview via `iframe`
  - fallback actions `Open PDF in new tab` and `Download PDF`
  - responsive default layout (stacked below `lg`, side-by-side at `lg` and above)
- PDF preview/fallback is available for both `pending_review` and `saved` upload review statuses.
- Yearly overview default-home slice (`008-yearly-overview-default-home`) is implemented.
- Root route (`/`) now renders a company-scoped yearly overview dashboard when active company context is valid.
- Overview UI includes:
  - selected-year KPI totals (income, expenses, result)
  - filter controls (`year`, `type`)
  - deterministic sort control (`documentDate`, `amount`, `documentNumber`, asc/desc)
  - workflow actions (`Upload invoice`, `Open queue`, `Switch company`)
  - source-file links for opening stored PDFs
- Overview filter/sort state is persisted in URL query params (`year`, `type`, `sort`) and restored on reload.
- Improved annual P&L view slice (`010-improved-annual-pl-view`) is implemented.
- Annual P&L UI route `/reports/annual-pl` now supports URL-persisted and normalized report state:
  - `year=YYYY`
  - `view=summary|details`
  - `mode=actual|compare|common_size`
- Annual P&L defaults and normalization behavior are implemented:
  - defaults to latest available year for the active company, fallback UTC current year if no entries
  - invalid query values are normalized deterministically via URL correction
- Annual P&L header/context bar includes:
  - active company context and fiscal year
  - workflow links (`Back to overview`, `Upload invoice`, `Open queue`, `Switch company`)
  - disabled `Export (coming soon)` placeholder action
- KPI strip supports current-year totals and compare-mode prior-year deltas for:
  - Revenue
  - Expenses
  - Net Result
  - Net Margin
- P&L statement table supports all required modes:
  - `actual`
  - `compare`
  - `common_size`
- Summary view uses canonical row ordering and subtotal emphasis with optional zero-only sections hidden.
- Details view is implemented with deterministic grouping/sorting:
  - income rows grouped by normalized counterparty name
  - expense rows grouped by expense type with unassigned bucket when applicable
- Statement rows provide drill-through links to filtered overview entries while preserving year/type context.
- Empty and warning states are implemented for no-data, selected-year-empty, and unassigned-expense scenarios.

## What remains
- Implement next planned features:
- `011-expense-type-pl-categorization` (expense-type P&L categorization for accurate annual P&L sums)
- AI extraction/review/save on top of the established review/save workflow
- Annual P&L export/generation workflow

## How to run (dev/validation)
- Dev server: `npm run dev`
- Lint: `npm run lint`
- Build: `npm run build`

## Known issues / open questions
- Product/spec open questions remain outside the active slices: future soft-delete/archive and pagination timing.
